var interfacePI={};interfacePI.setWxSelfInfoFun=null;interfacePI.setWxOpenidFun=null;interfacePI.openSortFun=null;interfacePI.closePageFun=null;interfacePI.setSortDataFun=null;interfacePI.setVersionFun=null;interfacePI.openResultFun=null;interfacePI.updateScoreFun=null;interfacePI.friendDataList=null;interfacePI.resizeFun=null;interfacePI.datacun=null;interfacePI.controlPage=null;interfacePI.ScollSortPage=null;wx.onMessage(function(e){console.log(e);if(e.type&&e.type=="wxxx"){sharedCanvas.width=e.width;sharedCanvas.height=e.height;console.log("-----------------sharedresize----------1------------------",sharedCanvas.width,sharedCanvas.height);if(e.version&&interfacePI.setVersionFun){interfacePI.setVersionFun(e.version)}}else if(e["isLoad"]=="filedata"){console.log("zhuyu isLoad")}else if(e.type&&e.type=="getselfclouddata"){wx.getUserCloudStorage&&wx.getUserCloudStorage({keyList:["score","time"],success:function(t){console.log("getUserCloudStorage:success",t.KVDataList);if(t){console.log("玩家数据",t.KVDataList[0],t.KVDataList[1],e.userinfo);if(e.userinfo){e.userinfo.nickname=e.userinfo.nickName;e.userinfo.KVDataList=t.KVDataList;interfacePI.setWxSelfInfoFun&&interfacePI.setWxSelfInfoFun(e.userinfo,e.time)}}},fail:function(){console.log("getUserCloudStorage:fail")},complete:function(){}})}else if(e.type&&e.type=="getOpenid"){interfacePI.setWxOpenidFun&&interfacePI.setWxOpenidFun(e.openid)}else if(e.type&&e.type=="ctntrolpage"){console.log("进入翻页",e.value,e);interfacePI.controlPage&&interfacePI.controlPage(e.ctntrol)}else if(e.type&&e.type=="ScollSortPage"){console.log("进入滚动",e.value,e);interfacePI.ScollSortPage&&interfacePI.ScollSortPage(e)}else if(e.type&&e.type=="opensort"){interfacePI.openSortFun&&interfacePI.openSortFun();if(e.shareTicket&&e.shareTicket!=""){interfacePI.getQunSortData(e.shareTicket,e.time)}else{interfacePI.getFriendData(0,e.time)}}else if(e.type&&e.type=="closepage"){interfacePI.closePageFun&&interfacePI.closePageFun(e.page)}else if(e.type&&e.type=="openresult"){interfacePI.getFriendData(1,e.showtype,e.score,e.time)}else if(e.type&&e.type=="updatescore"){interfacePI.updateScoreFun(e.score,e,e.etype)}else if(e.type&&e.type=="opensingleshow"){console.log("正式进入开放域",e.showType,e);interfacePI.openSingleShow(e.showType,e.time,e.score)}else if(e.type&&e.type=="chaoyue"){console.log("正式进入开放域",e.showType,e);interfacePI.openChaoyue(e.score,e.time)}else if(e.type&&e.type=="cleanchaoyue"){console.log("正式进入开放域",e.showType,e);interfacePI.cleanChaoYueFun&&interfacePI.cleanChaoYueFun()}});interfacePI.cleanChaoYueFun=function(){};interfacePI.updateSelfCloundData=function(t,e){wx.setUserCloudStorage&&wx.setUserCloudStorage({KVDataList:[{key:"score",value:t.toString()},{key:"time",value:e.toString()}],success:function(){console.log("setUserCloudStorage:success")},fail:function(){console.log("setUserCloudStorage:fail")},complete:function(){}})};interfacePI.getFriendData=function(e,i,a,n){wx.getFriendCloudStorage&&wx.getFriendCloudStorage({keyList:["score","time"],success:function(t){console.log("getFriendCloudStorage:success",t);if(t){if(e==0){interfacePI.setSortDataFun&&interfacePI.setSortDataFun(t.data,i)}else if(e==1){interfacePI.openResultFun&&interfacePI.openResultFun(i,a,t.data,n)}}},fail:function(){console.log("getFriendCloudStorage:fail")},complete:function(){}})};interfacePI.openSingleShow=function(e,i,a){wx.getFriendCloudStorage&&wx.getFriendCloudStorage({keyList:["score","time"],success:function(t){console.log("openSingleShow:success大爷进来了",t,e,i,a);if(t){interfacePI.openSingleShowFun&&interfacePI.openSingleShowFun(t,e,i,a)}},fail:function(){console.log("openSingleShow:fail")}})};interfacePI.openChaoyue=function(e,i){wx.getFriendCloudStorage&&wx.getFriendCloudStorage({keyList:["score","time"],success:function(t){if(t){interfacePI.openChaoYueFun&&interfacePI.openChaoYueFun(t,e,i)}},fail:function(){console.log("openChaoyue:fail")}})};interfacePI.cleanChaoyue=function(){};interfacePI.getQunSortData=function(t,i){console.log("interfacePI:getQunSortData");wx.getGroupCloudStorage&&wx.getGroupCloudStorage({shareTicket:t,keyList:["score","time"],success:function(t){console.log("getQunSortData:success",t);if(t){if(t.data){for(var e=0;e<t.data.length;e++){console.log("群玩家数据",e,t.data[e])}}interfacePI.setSortDataFun&&interfacePI.setSortDataFun(t.data,i)}},fail:function(){console.log("getQunSortData:fail")},complete:function(){}})};interfacePI.Canvas=function(t,e){return wx.createCanvas()};interfacePI.Image=function(t,e){return wx.createImage()};interfacePI.getSharedCanvas=function(t,e){return wx.getSharedCanvas()};var window={};console.log("window = ",window);window.externalInterfacePI=interfacePI;var page;(function(u){var t=function(){function s(t){this.SHOW_COUNT=50;this.PAGE_SIZE=5;this.ITEM_HEIGHT=110;this.PAGE_START_POSX=90;this.PAGE_START_POSY=45;this.PAGE_ITEM_OFFESTY=9;this._needLoadData=false;this._curIndex=0;this.isOpened=false;this._bgisLoad=false;this._scorebgisLoad=false;this._showHeight=0;this._isInit=false;this._min=0;this._max=0;this._oldStartY=0;this.imgCount=0;this.MY_RANK_POS=755;this._app=t;this.init()}s.prototype.init=function(){var t=window["externalInterfacePI"];var e=t.getSharedCanvas();this._showHeight=690;this._ctx=e.getContext("2d");this._ctx.imageSmoothingEnabled=true;this._ctx.imageSmoothingQuality="high"};s.prototype.open=function(){this.initImg();this._curIndex=0;this._oldStartY=0;if(this._needLoadData&&this._dataArr){this.updateShow();this.updateList(this._curIndex)}this.isOpened=true};s.prototype.initImg=function(){if(!this._isInit){this._isInit=true;u.ResMgr.getRes("top/top1.png",null);u.ResMgr.getRes("top/top2.png",null);u.ResMgr.getRes("top/top3.png",null);u.ResMgr.getRes("tongyong/wpk_1.png",null);u.ResMgr.getRes("top/tu_yd.png",null);u.ResMgr.getRes("top/tu_di.png",null);u.ResMgr.getRes("top/1_1.png",null);u.ResMgr.getRes("top/1_2.png",null);u.ResMgr.getRes("top/1_3.png",null);u.ResMgr.getRes("top/1_4.png",null);u.ResMgr.getRes("top/1_5.png",null);u.ResMgr.getRes("top/1_6.png",null);u.ResMgr.getRes("top/1_7.png",null);u.ResMgr.getRes("top/1_8.png",null);u.ResMgr.getRes("top/1_9.png",null);u.ResMgr.getRes("top/1_10.png",null);u.ResMgr.getRes("top/1_11.png",null)}};s.prototype.close=function(){this.isOpened=false;this._ctx.clearRect(0,0,1e3,1e3)};s.prototype.setData=function(t){this._dataArr=t;if(!this.isOpened){this._needLoadData=true;return}this.updateShow();this.updateList(this._curIndex);var e=this._app.wxSelfInfo;var i=0;console.log("self",e);var a=this._dataArr?this._dataArr.length:0;for(var n=0;n<a;n++){var s=this._dataArr[n];if(!s)continue;i++}};s.prototype.updateShow=function(){console.log("进来level");if(!this._dataArr)return;if(!this._dataShowArr){this._dataShowArr=new Array}else{this._dataShowArr.length=0}var t=0;for(var e=0;e<this._dataArr.length;e++){var i=this._dataArr[e];if(!i||!i["openid"])continue;if(t<this.SHOW_COUNT){this._dataShowArr.push(i);t++}}console.log("打印出max!!!!!");var a=this._dataShowArr.length*this.ITEM_HEIGHT;this._max=a-this._showHeight;if(this._max<0)this._max=0};s.prototype.controlPage=function(t){var e=Math.ceil(this._dataShowArr.length/this.PAGE_SIZE);var i;switch(t){case"up":this._curIndex--;if(this._curIndex<0)this._curIndex=0;this.updateList(this._curIndex);break;case"next":this._curIndex++;if(this._curIndex>e)this._curIndex=e;this.updateList(this._curIndex);break}};s.prototype.updateDela=function(t){this._oldStartY+=t;if(this._oldStartY<this._min)this._oldStartY=this._min;if(this._oldStartY>this._max)this._oldStartY=this._max;this.updateList(this._oldStartY)};s.prototype.updateList=function(t){var e=window["externalInterfacePI"];this._updateList(t)};s.prototype._updateList=function(t){var e=Math.floor(t/this.ITEM_HEIGHT);console.log(e);var i=this._dataShowArr.slice(e,e+this.PAGE_SIZE+1);var a=i.length;this._ctx.clearRect(0,0,1e3,1e3);this.imgCount=0;for(var n=0;n<a;n++){this.drawRankItem(this._ctx,n,e+n+1,i[n],t)}this.drawMyRank()};s.prototype.drawRankItem=function(i,t,a,e,n){var s=this;var o=window["externalInterfacePI"];var r=e.avatarUrl;var l=e.nickname.length>5?e.nickname.slice(0,5)+"...":e.nickname;var f=e.score;var h=this.ITEM_HEIGHT*(a-1)-n;var c=this.PAGE_START_POSX;var g=this.PAGE_START_POSY+h;u.ResMgr.getRes("top/tu_di.png",function(t){i.drawImage(t,c,g,545,100);if(a<=3){u.ResMgr.getRes("top/top"+a+".png",function(t){i.drawImage(t,c+10,g+5,56,84)})}else{i.font="55px Arial";i.fillStyle="#3d7e9c";i.fillText(""+a,c+60,g+65)}u.ResMgr.getRes("tongyong/wpk_1.png",function(t){i.drawImage(t,c+110,g+5,87,87);u.ResMgr.getRes(r,function(t){i.drawImage(t,c+110,g+5,87,87)})});i.fillStyle="#3d7e9c";i.font="28px SimSun";i.textAlign="left";i.lineWidth=1;i.strokeStyle="#3d7e9c";i.strokeText(l,c+230,g+34);i.fillText(l,c+230,g+34);var e=s.getTextChanegHao(f);u.ResMgr.getRes("top/1_"+(e+1)+".png",function(t){i.drawImage(t,c+230,g+50)});u.ResMgr.getRes("top/tu_yd.png",function(t){i.drawImage(t,c+425,g+23);i.fillStyle="#ffffff";i.font="32px SimSun";i.textAlign="right";i.lineWidth=2;i.strokeStyle="#ffffff";i.strokeText(""+f,c+515,g+53);i.fillText(""+f,c+515,g+53)})})};s.prototype.getTextChanegHao=function(t){for(var e=0;e<s.DATATEXT.length;e++){var i=s.DATATEXT[e];var a=i.score;var n=i.text;if(t<a){return e}else{continue}}};s.prototype.drawMyRank=function(){var e=this;this._ctx.clearRect(0,800,1e3,1e3);console.log("打印自己的数据",this._app.wxSelfInfo);if(!this._app.wxSelfInfo)return;var t;var i;for(var a=0;a<this._dataArr.length;a++){if(this._app.wxSelfInfo&&this._app.wxSelfInfo.openid==this._dataArr[a].openid){t=this._dataArr[a];i=a+1;break}}var n=t.nickname;var s=n.length>5?n.slice(0,5)+"...":n;if(!i)i="未上榜";if(i<=3){u.ResMgr.getRes("top/top"+i+".png",function(t){e._ctx.drawImage(t,e.PAGE_START_POSX+10,e.MY_RANK_POS,56,84)})}else{this._ctx.font="55px Arial";this._ctx.fillStyle="#3d7e9c";this._ctx.fillText(""+i,this.PAGE_START_POSX+65,this.MY_RANK_POS+55)}var o=t.avatarUrl;u.ResMgr.getRes("tongyong/wpk_1.png",function(t){e._ctx.drawImage(t,e.PAGE_START_POSX+110,e.MY_RANK_POS,87,87);u.ResMgr.getRes(o,function(t){e._ctx.drawImage(t,e.PAGE_START_POSX+110,e.MY_RANK_POS,87,87)})});this._ctx.fillStyle="#3d7e9c";this._ctx.font="28px SimSun";this._ctx.textAlign="left";this._ctx.lineWidth=2;this._ctx.strokeStyle="#3d7e9c";this._ctx.strokeText(s,this.PAGE_START_POSX+226,this.MY_RANK_POS+30);this._ctx.fillText(s,this.PAGE_START_POSX+226,this.MY_RANK_POS+30);var r=t.score;var l=this.getTextChanegHao(r);var f=this.getTextChanegHao(r);u.ResMgr.getRes("top/1_"+(f+1)+".png",function(t){e._ctx.drawImage(t,e.PAGE_START_POSX+230,e.MY_RANK_POS+40)});u.ResMgr.getRes("top/tu_yd.png",function(t){e._ctx.drawImage(t,e.PAGE_START_POSX+425,e.MY_RANK_POS+20);e._ctx.fillStyle="#ffffff";e._ctx.font="32px SimSun";e._ctx.textAlign="right";e._ctx.lineWidth=2;e._ctx.strokeStyle="#ffffff";e._ctx.strokeText(""+r,e.PAGE_START_POSX+515,e.MY_RANK_POS+49);e._ctx.fillText(""+r,e.PAGE_START_POSX+515,e.MY_RANK_POS+49)})};return s}();t.DATATEXT=[{score:100,text:"学徒"},{score:200,text:"勇者"},{score:300,text:"大侠"},{score:500,text:"神勇"},{score:750,text:"霸主"},{score:1e3,text:"宗师"},{score:1500,text:"主宰"},{score:2e3,text:"暴走"},{score:3e3,text:"无敌"},{score:5e3,text:"王者"},{score:9999999,text:"超神"}];u.SortPageScoll=t})(page||(page={}));var page;(function(h){var t=function(){function f(t){this.isOpened=false;this._clearRectWidth=1e3;this._clearRectHeight=1e3;this._diffNum=200;this._app=t;this.init()}f.prototype.init=function(){var t=window["externalInterfacePI"];var e=t.getSharedCanvas();console.log(e.width,e.height);this._ctx=e.getContext("2d");this._ctx.imageSmoothingEnabled=true;this._ctx.imageSmoothingQuality="high"};f.prototype.open=function(){this.isOpened=true};f.prototype.setData=function(t,e,i){this._score=i;console.log("进入绘制头像了！！  score = ",i);if(!t||t.length<=0)return;this._friendData=t;console.log("打印赋值头像数据",this._friendData);this._ctx.clearRect(0,0,this._clearRectWidth,this._clearRectHeight);this.drawHead(e)};f.prototype.drawHead=function(t){var i=this;console.log("老子要开始绘制",t);var e=this._app.wxSelfInfo;console.log(this._app.wxSelfInfo);var a;if(t==f.TYPE_SINGLE){for(var n=0;n<this._friendData.length;n++){if(this._score>=this._friendData[n].score){console.log("超越分数了",e.score,this._friendData[n].score);a=n-1;break}}if(!a&&a!=0){console.log("index不存在",a);a=this._friendData.length-1}console.log("即将超越",e,this._friendData,a);var s=this._friendData[a];if(!s){this._ctx.font="45px Arial";this._ctx.fillStyle="#ffffff";this._ctx.fillText("已经是第一名啦",20,60)}else{var o=s.avatarUrl;if(o){h.ResMgr.getRes(o,function(t,e){i._ctx.drawImage(t,10,5,80,80);console.log("老子要开始绘制分数",s.score);i._ctx.font="45px Arial";i._ctx.fillStyle="#ffffff";i._ctx.strokeStyle="#ffffff";i._ctx.textAlign="left";i._ctx.lineWidth=2;i._ctx.strokeText(s.score,180,65);i._ctx.fillText(s.score,180,65)})}}}else if(t==f.TYPE_THREE){console.log("结算超越",this._friendData);for(var n=0;n<this._friendData.length;n++){if(e&&e.openid==this._friendData[n].openid){a=n}}if(!e){a=0}console.log("老子要index",a);var r=[];var l=void 0;if(this._friendData.length>=3){if(a==0){r.push(this._friendData[a]);r.push(this._friendData[a+1]);r.push(this._friendData[a+2]);l=1}if(a==this._friendData.length-1){r.push(this._friendData[a-2]);r.push(this._friendData[a-1]);r.push(this._friendData[a]);l=2}if(this._friendData[a+1]&&this._friendData[a-1]){r.push(this._friendData[a-1]);r.push(this._friendData[a]);r.push(this._friendData[a+1]);l=3}console.log("老子要开始绘制分数",r)}else if(this._friendData.length==2){r.push(this._friendData[0]);r.push(this._friendData[1]);l=a==0?1:2}else if(this._friendData.length==1){r.push(this._friendData[0]);l=1}for(var n=0;n<r.length;n++){this.drawOther(r[n],n,a+1,l)}}};f.prototype.drawOther=function(t,i,e,a){var n=this;var s=t;if(!s||!s.avatarUrl)return;var o=s.avatarUrl;var r;var l=t.nickname;var f=t.openid==this._app.wxSelfInfo.openid?true:false;switch(a){case 1:r=e+i;break;case 2:r=e+(i-2);break;case 3:r=i==0?e-1:i==1?e:e+1;break}this._ctx.fillStyle=f?"#ffff08":"#ffffff";this._ctx.font="32px Arial";this._ctx.textAlign="center";this._ctx.lineWidth=2;this._ctx.strokeStyle="#000000";this._ctx.strokeText(r,70+this._diffNum*i,25);this._ctx.fillText(r,70+this._diffNum*i,25);if(o){h.ResMgr.getRes(o,function(t,e){n._ctx.drawImage(t,n._diffNum*i+35,31,80,80)})}this._ctx.fillStyle=f?"#ffff08":"#ffffff";this._ctx.font="32px Arial";this._ctx.textAlign="center";this._ctx.lineWidth=2;this._ctx.strokeStyle="#000000";this._ctx.strokeText(l,70+this._diffNum*i,151);this._ctx.fillText(l,70+this._diffNum*i,151);this._ctx.fillStyle=f?"#ffff08":"#ffffff";this._ctx.font="32px Arial";this._ctx.textAlign="center";this._ctx.lineWidth=2;this._ctx.strokeStyle="#000000";this._ctx.strokeText(s.score,70+this._diffNum*i,191);this._ctx.fillText(s.score,70+this._diffNum*i,191)};f.prototype.close=function(){this.isOpened=false;this._ctx.clearRect(0,0,this._clearRectWidth,this._clearRectHeight)};return f}();t.TYPE_SINGLE=0;t.TYPE_THREE=1;h.singeleShowPage=t})(page||(page={}));var page;(function(h){var t=function(){function t(t){this.SHOW_COUNT=50;this.PAGE_SIZE=6;this.ITEM_HEIGHT=162;this._needLoadData=false;this.isOpened=false;this._bgisLoad=false;this._bg1isLoad=false;this._bg2isLoad=false;this._bg3isLoad=false;this._app=t;this.init()}t.prototype.init=function(){var t=window["externalInterfacePI"];var e=t.getSharedCanvas();this._ctx=e.getContext("2d");this._ctx.imageSmoothingEnabled=true;this._ctx.imageSmoothingQuality="high"};t.prototype.open=function(){if(this._needLoadData&&this._dataArr){this.updateShow();this.updateList()}this.isOpened=true};t.prototype.close=function(){this.isOpened=false;this._ctx.clearRect(0,0,1e3,1e3)};t.prototype.setData=function(t,e,i){console.log("====================",t,e,i);this._dataArr=i;if(!this.isOpened){this._needLoadData=true;return}this.updateShow();this.updateList();var a=this._app.wxSelfInfo;var n=0;var s=0;console.log("self",a);var o=this._dataArr?this._dataArr.length:0;var r=0;for(var l=0;l<o;l++){var f=this._dataArr[l];if(!f)continue;n++}};t.prototype.updateShow=function(){console.log("进来level");if(!this._dataArr)return;if(!this._dataShowArr){this._dataShowArr=new Array}else{this._dataShowArr.length=0}console.log("updateShow",this._dataArr.length);var t=0;var e=0;var i=this._app.wxSelfInfo;for(var a=0;a<this._dataArr.length;a++){var n=this._dataArr[a];if(!n)continue}if(e==0){for(var a=0;a<this._dataArr.length&&a<3;a++){this._dataArr[a].rank=a+1;this._dataShowArr.push(this._dataArr[a])}}else{for(var a=e-1;a<this._dataArr.length&&a<e+2;a++){this._dataArr[a].rank=a+1;this._dataShowArr.push(this._dataArr[a])}}};t.prototype.updateList=function(){var t=this;var e=window["externalInterfacePI"];if(!this._bg1){this._bg1=e.Image();this._bg1.src="ui/jiesuan/tu_d1.png";this._bg1.onload=function(){t._bg1isLoad=true;t._updateList()}}if(this._bg1isLoad)this._updateList();if(!this._bg2){this._bg2=e.Image();this._bg2.src="ui/jiesuan/tu_d2.png";this._bg2.onload=function(){t._bg2isLoad=true;t._updateList()}}if(this._bg2isLoad)this._updateList();if(!this._bg3){this._bg3=e.Image();this._bg3.src="ui/jiesuan/tu_d3.png";this._bg3.onload=function(){t._bg3isLoad=true;t._updateList()}}if(this._bg3isLoad)this._updateList()};t.prototype._updateList=function(){var t=this._dataShowArr;var e=t.length;this._ctx.clearRect(0,0,1e3,1e3);console.log("this.updateList.page",e);for(var i=0;i<e;i++){this.drawRankItem(this._ctx,i,t[i].rank,t[i])}};t.prototype.drawRankItem=function(e,t,i,a){var n=window["externalInterfacePI"];var s=a.avatarUrl;var o=a.nickname.length<=10?a.nickname:a.nickname.substr(0,10)+"...";var r=a.score;var l=(this.ITEM_HEIGHT+8)*t;console.log("this.drawRankItem",t,o);var f=i<3?i:3;e.drawImage(this["_bg"+f],l+60,50,162,279);e.beginPath();e.moveTo(l+96,78);e.lineTo(l+184,78);e.lineTo(l+184,166);e.lineTo(l+96,166);e.lineTo(l+96,78);e.closePath();e.lineWidth=3;e.strokeStyle="block";e.lineJoin="round";e.stroke();h.ResMgr.getRes(s,function(t){e.drawImage(t,l+96,78,88,88)});e.baseLine="middle";e.font="bold 16px Arial";e.fillStyle="#ffffff";e.textAlign="center";e.fillText(o,l+140,200,80);e.baseLine="middle";e.font="bold 36px Arial";e.fillStyle="#ffffff";e.textAlign="center";e.fillText(""+r,l+138,258);h.ResMgr.getRes("ui/jiesuan/top_"+f+".png",function(t){e.drawImage(t,l+98,15,80,80)})};return t}();h.ResultPage=t})(page||(page={}));var page;(function(t){var e=function(){function l(){}l.resDatas=function(){return l._resDatas};l.getRes=function(t,e,i){if(i===void 0){i=-1}var a;for(var n=0;n<l._resDatas.length;n++){var s=l._resDatas[n];if(s.resPath==t){s.index=i;a=s;break}}if(!a){var o=window["externalInterfacePI"];a=new f;l._resDatas.push(a);a.resPath=t;a.img=o.Image();a.img.src=t;if(e)a.funs.push(e);a.index=i;a.img.onload=function(){a.isLoad=true;a.done()}}else{var r=false;for(var n=0;n<a.funs.length;n++){if(a.funs[n]==e){r=true}}if(!r)a.funs.push(e);if(a.isLoad)a.done()}};l.clear=function(){this._resDatas.length=0};return l}();e._resDatas=[];t.ResMgr=e;var f=function(){function t(){this.resPath="";this.isLoad=false;this.funs=[]}t.prototype.done=function(){if(this.funs){while(this.funs.length>0){var t=this.funs.shift();if(t)t(this.img,this.index)}}};return t}()})(page||(page={}));var page;(function(s){var t=function(){function t(t){this.isOpened=false;this._clearRectWidth=100;this._clearRectHeight=100;this._index=0;this._isDraw=false;this._curData=[];this._app=t;this.init()}t.prototype.init=function(){var t=window["externalInterfacePI"];var e=t.getSharedCanvas();console.log(e.width,e.height);this._ctx=e.getContext("2d");this._ctx.imageSmoothingEnabled=true;this._ctx.imageSmoothingQuality="high"};t.prototype.open=function(){this.isOpened=true};t.prototype.setData=function(t,e){console.log("进入绘制头像了！！");if(!t||t.length<=0)return;this._friendData=t;console.log("打印赋值头像数据",this._friendData);this.drawHead(e)};t.prototype.clean=function(){if(this._ctx)this._ctx.clearRect(0,0,this._clearRectWidth,this._clearRectHeight)};t.prototype.drawHead=function(t){var i=this;this._friendData=this._friendData.reverse();if(this._curData.length==0)this._curData=this._friendData;console.log("初始化",this._index);for(var e=this._index;e<this._curData.length;e++){if(t>=this._curData[e].score){this._index=e;this._isDraw=true;break}else{this._isDraw=false}}var a=this._curData[this._index];var n=a.avatarUrl;this._ctx.clearRect(0,0,this._clearRectWidth,this._clearRectHeight);if(n&&this._isDraw){this._curData.shift();this._isDraw=false;s.ResMgr.getRes(n,function(t,e){i._ctx.drawImage(t,0,25,60,60);console.log("成功绘制");i._ctx.font="22px Arial";i._ctx.fillStyle="#ffffff";i._ctx.strokeStyle="#000000";i._ctx.textAlign="left";i._ctx.lineWidth=3;i._ctx.strokeText("超越",8,18);i._ctx.fillText("超越",8,18)})}else{console.log("成功绘制")}};t.prototype.close=function(){this.isOpened=false;this._ctx.clearRect(0,0,this._clearRectWidth,this._clearRectHeight)};return t}();t.TYPE_SINGLE=0;s.chaoyue=t})(page||(page={}));var SortPage=page.SortPageScoll;var ResultPage=page.ResultPage;var singleShowPage=page.singeleShowPage;var chaoyue=page.chaoyue;var ResMgr=page.ResMgr;var GameMain=function(){function t(){this._curTime=0;this._clientWidth=0;this._clientHeight=0;this._date=new Date}Object.defineProperty(t.prototype,"clientWidth",{get:function(){return this._clientWidth},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"clientHeight",{get:function(){return this._clientHeight},enumerable:true,configurable:true});t.prototype.addListen=function(){var n=this;var t=window["externalInterfacePI"];if(t){t.setWxSelfInfoFun=function(t,e){if(!t)return;n._curTime=e;n.setWxSelfInfo(t)};t.setWxOpenidFun=function(t){if(!t)return;n.setWxOpenid(t)};t.openSortFun=function(){n.openSort()};t.closePageFun=function(t){n.closePage(t)};t.setSortDataFun=function(t,e){if(!t)return;n._curTime=e;n.setSortData(n.changeDataList(t))};t.openResultFun=function(t,e,i,a){if(!i)return;n._curTime=a;n.openResult(t,e,n.changeDataList(i))};t.updateScoreFun=function(t,e,i){if(!e)return;console.log("上传成绩,开放域",t,e,i);if(e)n.friendDataList=n.changeDataList(e);console.log("经过替换之后",t,t);n.updateSelfScore(t,i)};t.controlPage=function(t){if(t){if(n._sortPage){console.log("data.type",t.ctntrol,t);n._sortPage.controlPage(t)}}};t.ScollSortPage=function(t){if(t){if(n._sortPage){console.log("ScollSortPage",t.ctntrol);n._sortPage.updateDela(t.ctntrol)}}};t.openSingleShowFun=function(t,e,i,a){if(!t)return;n._curTime=i;console.log("进入LayaSample");n.setSingleShow(n.changeDataList(t.data),e,a)};t.openChaoYueFun=function(t,e,i){if(!t)return;n._curTime=i;console.log("进入LayaSample");n.setChaoYue(n.changeDataList(t.data),e)};t.cleanChaoYueFun=function(){n.setChaoYueClean()}}};t.prototype.setWxSelfInfo=function(t){console.log("开放域 获取了用户信息",t);if(!this.wxSelfInfo){this.wxSelfInfo=new Object}var e=this.changeDataSingele(t);this.wxSelfInfo.nickname=e.nickname;this.wxSelfInfo.avatarUrl=e.avatarUrl;this.wxSelfInfo.score=e.score;this.wxSelfInfo.time=e.time};t.prototype.setWxOpenid=function(t){if(!this.wxSelfInfo){this.wxSelfInfo=new Object}this.wxSelfInfo.openid=t};t.prototype.changeDataSingele=function(t){if(!t)return null;var e=new Object;e.openid=t.openid?t.openid:"";e.nickname=t.nickname?t.nickname:"";e.avatarUrl=t.avatarUrl?t.avatarUrl:"ui/top/wpk_2.png";if(e.avatarUrl)ResMgr.getRes(e.avatarUrl,null);var i=t.KVDataList;var a=0;var n=0;if(i){var s=i.length;for(var o=0;o<s;o++){var r=i[o];if(!r)continue;if(r.key=="score"&&r.value){a=parseInt(r.value)}else if(r.key=="time"&&r.value){n=parseInt(r.value)}}}e.score=a;e.time=n;return e};t.prototype.getWeekOneDayByTime=function(t){if(!t)return 0;this._date.setTime(t);var e=this._date.getDay();if(e==0)e=7;var i=t-(e-1)*864e5;if(i>0)this._date.setTime(i);var a=this._date.getFullYear();var n=this._date.getMonth();var s=this._date.getDate();var o=a.toString()+n.toString()+s.toString();return parseInt(o)};t.prototype.changeDataList=function(t){var e=[];if(!t)return e;var i=this.getWeekOneDayByTime(this._curTime);console.log("time",i);var a=t.length;console.log("len",a);for(var n=0;n<a;n++){var s=this.changeDataSingele(t[n]);if(!s)continue;e.push(s)}e.sort(this.sortByScore);return e};t.prototype.sortByScore=function(t,e){return e.score-t.score};t.prototype.openSort=function(){if(!this._sortPage){this._sortPage=new SortPage(this)}if(!this._sortPage.isOpened){this._sortPage.open()}};t.prototype.setSortData=function(t){if(!this._sortPage){this.openSort()}if(this._sortPage)this._sortPage.setData(t)};t.prototype.setSingleShow=function(t,e,i){console.log("老子要打开页面了",t,e);if(!this._singleShowPage){this._singleShowPage=new singleShowPage(this)}if(this._singleShowPage){this._singleShowPage.setData(t,e,i)}};t.prototype.setChaoYue=function(t,e){if(!this._chaoyuePage){this._chaoyuePage=new chaoyue(this)}this._chaoyuePage.setData(t,e)};t.prototype.setChaoYueClean=function(){if(!this._chaoyuePage){this._chaoyuePage=new chaoyue(this)}this._chaoyuePage.clean()};t.prototype.closePage=function(t){if(t=="sort"){if(this._sortPage)this._sortPage.close()}else if(t=="result"){if(this._resultPage)this._resultPage.close()}else if(t=="singlePage"||t=="thirdHead"){console.log("老子被关闭啦啊啊啊啊啊",t,this._singleShowPage);if(this._singleShowPage){this._singleShowPage.close();this._singleShowPage=null}}};t.prototype.openResult=function(t,e,i){console.log("子域openSort"+t+"|"+e);if(this.wxSelfInfo){this.wxSelfInfo.newScore=e}if(!this._resultPage){console.log("type,score==="+t+"|"+e);this._resultPage=new ResultPage(this)}if(!this._resultPage.isOpened){console.log("type,score"+t+"|"+e);this._resultPage.open();this._resultPage.setData(t,e,i)}else{this._resultPage.close()}if(this.wxSelfInfo){var a=this.getWeekOneDayByTime(this._curTime);if(this.wxSelfInfo.time!=a||this.wxSelfInfo.score<e){this.wxSelfInfo.score=e;this.wxSelfInfo.time=a;var n=window["externalInterfacePI"];if(n){n.updateSelfCloundData(e,a)}}}};t.prototype.updateSelfScore=function(t,e){console.log("子域openSort");if(this.wxSelfInfo){this.wxSelfInfo.newScore=t;if(e==1){var i=this.getWeekOneDayByTime(this._curTime);console.log("+++++++++++++++++++++++++++++++++++++++++++++:"+t);if(this.wxSelfInfo.score<t){console.log("上传乘成绩了"+t);this.wxSelfInfo.score=t;this.wxSelfInfo.time=i;var a=window["externalInterfacePI"];if(a){a.updateSelfCloundData(t,i)}}}}};return t}();var game=new GameMain;game.addListen();